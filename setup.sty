\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{setup}

% =========================================
% 1. TYPOGRAPHY & ENCODING
% =========================================
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc} % Explicitly stating utf8 is good practice
\RequirePackage{microtype}      % Micro-adjustments for perfect justification

% --- Fonts ---
% Garamond for body text (Classic, "Notebook" feel)
\RequirePackage[lining]{ebgaramond}
% Math font that matches Garamond
\RequirePackage[cmintegrals,cmbraces]{newtxmath}

% =========================================
% 2. PAGE LAYOUT (A5 Format)
% =========================================
\RequirePackage[
    a5paper,
    margin=0.6in,
    bindingoffset=0.2in,
    heightrounded,
    headheight=15pt
]{geometry}

% =========================================
% 3. COLORS
% =========================================
\RequirePackage{xcolor}
% Define a palette for the book
\definecolor{techblue}{RGB}{0, 50, 90}   % Deep technical blue for headers
\definecolor{notegray}{RGB}{245, 245, 245} % Light gray for box backgrounds
\definecolor{accentred}{RGB}{150, 0, 0}  % For emphasis/alert

% --- Semantic Box Colors ---
\definecolor{colorTheorem}{RGB}{140, 20, 20}   % Burgundy (Rigor)
\definecolor{colorDef}{RGB}{0, 90, 70}         % Forest Teal (Structure)
\definecolor{colorResult}{RGB}{0, 50, 90}      % Tech Blue (Outcome)
\definecolor{colorCuriosity}{RGB}{180, 100, 0} % Burnt Amber (The "Weird")
\definecolor{colorRef}{RGB}{70, 80, 90}

% =========================================
% 4. MATH & SCIENCE PACKAGES
% =========================================
\RequirePackage{amsmath}
% Load amsthm with option to prevent \openbox redefinition conflict with newtxmath
\let\openbox\relax
\RequirePackage{amsthm}
\RequirePackage{mathtools} % Fixes/extends amsmath

% --- Physics & Derivatives ---
% 'physics' provides convenient bras, kets, matrices, and simplified \dv
\RequirePackage{physics}

% =========================================
% 5. GRAPHICS & FIGURES
% =========================================
\RequirePackage{graphicx}
\RequirePackage{float}
\RequirePackage{tikz}
\usetikzlibrary{trees, shapes.geometric, positioning, calc, arrows.meta, shadows}

% =========================================
% 6. NAVIGATION (Hyperlinks)
% =========================================
% Must be loaded before formatting packages that modify headers usually
\RequirePackage[
    colorlinks=true,
    linkcolor=techblue,
    citecolor=techblue,
    urlcolor=accentred,
    pdfborder={0 0 0}
]{hyperref}

% =========================================
% 7. HEADER & FOOTER DESIGN
% =========================================
\RequirePackage{fancyhdr}
\RequirePackage[defaultlines=4,all]{nowidow} % Prevent orphans/widows

\pagestyle{fancy}
\fancyhf{} % Clear defaults
\renewcommand{\headrulewidth}{0.5pt}
% Text in header is small, italic, and techblue
\fancyhead[CE]{\itshape\small\color{techblue}\authorname}
\fancyhead[CO]{\itshape\small\color{techblue}\booktitle}
\fancyfoot[C]{\small\thepage}

% =========================================
% 8. CHAPTER & SECTION STYLING (The Aesthetic Upgrade)
% =========================================
\RequirePackage[explicit]{titlesec}

% --- Chapter Title Style ---
% A large number on the right, rule line, and title below
\titleformat{\chapter}[display]
{\normalfont\huge\bfseries\color{techblue}} % Format applied to title
{\filleft\fontsize{60}{70}\selectfont\color{gray!25}\thechapter} % The Chapter Number
{-30pt} % Spacing (Move title up to overlap the big gray number slightly)
{\filleft\Huge\itshape #1} % The Title Text
[\vspace{1ex}\titlerule] % Horizontal line after title

% --- Section Title Style ---
\titleformat{\section}
{\normalfont\Large\bfseries\color{techblue}}
{\thesection}{1em}{#1}

\titleformat{\subsection}
{\normalfont\large\bfseries\color{black}}
{\thesubsection}{1em}{#1}

% =========================================
% 9. THEOREM & DEFINITION BOXES
% =========================================
\RequirePackage[nameinlink]{cleveref}
\RequirePackage[most]{tcolorbox}
% --- 1. The Base Style (Layout) ---
% All boxes share this physical shape, they only differ in color.
\tcbset{
    commonbox/.style={
            enhanced,
            fonttitle=\bfseries\small,
            coltitle=white,
            boxrule=0.5pt,
            arc=2pt,
            leftrule=3pt, % Thicker left border
            % The "Tab" effect
            attach boxed title to top left={yshift=-7.5pt, xshift=10pt},
            boxed title style={frame hidden},
            % Spacing inside the box
            top=1em, bottom=1em, left=1em, right=1em
        }
}

% --- 2. The Semantic Styles (Colors) ---

% Theorem: Burgundy
\tcbset{
    styleTheorem/.style={
            commonbox,
            colback=colorTheorem!5,  % 5% opacity background
            colframe=colorTheorem,   % Solid frame
            boxed title style={colback=colorTheorem}
        }
}

% Definition: Teal
\tcbset{
    styleDef/.style={
            commonbox,
            colback=colorDef!5,
            colframe=colorDef,
            boxed title style={colback=colorDef}
        }
}

% Result: Tech Blue
\tcbset{
    styleResult/.style={
            commonbox,
            colback=colorResult!5,
            colframe=colorResult,
            boxed title style={colback=colorResult}
        }
}

% Curiosity: Amber
\tcbset{
    styleCuriosity/.style={
            commonbox,
            colback=colorCuriosity!5,
            colframe=colorCuriosity,
            boxed title style={colback=colorCuriosity}
        }
}
% Reference: Slate Gray

\tcbset{
    styleRef/.style={
            commonbox,
            colback=colorRef!5,
            colframe=colorRef,
            boxed title style={colback=colorRef}
        }
}
% --- 3. Environment Definitions ---
\newtcbtheorem[number within=chapter]{theorem}{Theorem}{styleTheorem}{th}
\newtcbtheorem[number within=chapter]{definition}{Definition}{styleDef}{def}
\newtcbtheorem[number within=chapter]{result}{Result}{styleResult}{res}
\newtcbtheorem[number within=chapter]{curiosity}{Curiosity}{styleCuriosity}{cur}
\newtcbtheorem[number within=chapter]{reference}{Reference}{styleRef}{ref}

% --- 4. Cleveref Names (Define these AFTER the boxes) ---
\crefname{tcb@cnt@theorem}{Theorem}{Theorems}
\crefname{tcb@cnt@definition}{Definition}{Definitions}
\crefname{tcb@cnt@result}{Result}{Results}
\crefname{tcb@cnt@curiosity}{Curiosity}{Curiosities}
\crefname{tcb@cnt@reference}{Reference}{References}
% =========================================
% 10. TABLE OF CONTENTS & DROPCAPS
% =========================================
\RequirePackage{lettrine}
\RequirePackage[titles]{tocloft}

% Configure Lettrine (Drop Caps)
\setcounter{DefaultLines}{2}              % Drop 2 lines deep
\renewcommand{\DefaultLoversize}{0.1}     % Vertical height boost (0.1 is subtle)
\renewcommand{\LettrineFontHook}{\color{techblue}} % The Big Letter Color
\renewcommand{\LettrineTextFont}{\scshape\color{techblue}} % "HIS BOOK" color

\setlength{\DefaultFindent}{0.5em}        % Gap between Letter and text
\setlength{\DefaultNindent}{0em}          % Indent of the second line

% =========================================
% 11. GENERAL SETTINGS
% =========================================

% CC Icons
\RequirePackage{ccicons} % Adds vector icons for Creative Commons

% Paragraph formatting
\renewcommand{\baselinestretch}{1.15}
\setlength{\parskip}{0.5em}
\setlength{\parindent}{0pt} % Modern style: space between paragraphs, no indent
\raggedbottom

% Helper command for spacing in formulas
\newcommand{\hsp}{\kern 1pt}

% --- Custom Logos ---
% Usage: \nonsenseLogo (defaults to blue) or \nonsenseLogo[white]
\newcommand{\nonsenseLogo}[1][techblue]{%
    \begin{tikzpicture}[scale=0.5] % Removed baseline adjustment
        % The Geometry
        \draw[thick, #1] (0,0) circle (1.25cm);
        \draw[thin, #1]  (0,0) circle (1cm);

        % The Text
        % 1. We force the node to be centered exactly at 0,0
        % 2. We explicitly set the font size to \large so it doesn't shrink/grow unpredictably
        % 3. We use \mkern to tighten the gap between N and P
        \node[#1, anchor=center, inner sep=0pt] at (0,0) {%
            \large\bfseries $\mathcal{N}\mkern-3mu\mathcal{P}$%
        };
    \end{tikzpicture}%
}